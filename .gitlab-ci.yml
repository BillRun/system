image: docker
stages:
  - build
  - test

print-info:
 stage: build
 rules:
   - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS == "skip_ci"
 when: manual
 script:
   - 'echo "Job start: $CI_JOB_STARTED_AT"'
   - 'echo "Branch: $CI_COMMIT_BRANCH"'
   - 'echo "Commit Author: $CI_COMMIT_AUTHOR"'
codecept:
  services:
   - name: docker:dind
     alias: dockerhost
  when: manual
  variables:
    DOCKER_HOST: tcp://dockerhost:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  stage: test
  tags:
    - new_docker_runner
  # rules:
  #   - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS != "skip_ci"
  before_script:
    # build and run BillRun app in docker 
    - mkdir logs cache
    - chmod 777 logs/ cache/
    - cp $TEST_ENV_CODECEPT $CI_PROJECT_DIR/tests/.env
    - cd $CI_PROJECT_DIR/docker/billrun-docker
    - docker-compose -f docker-compose-php73-tests.yml up --wait --build --detach
  script:
    - cd $CI_PROJECT_DIR/docker/billrun-docker/
    - docker exec -w /billrun billrun-app php vendor/bin/codecept build
    - docker exec -w /billrun billrun-app php vendor/bin/codecept run unit
    - docker exec -w /billrun billrun-app php vendor/bin/codecept run functional
    - docker exec -w /billrun billrun-app php vendor/bin/codecept run api
    - docker exec -w /billrun billrun-app php vendor/bin/codecept run acceptance
    - docker exec -w /billrun billrun-app php vendor/bin/codecept run all 
    - cd $CI_PROJECT_DIR/docker/billrun-docker
    - docker-compose -f docker-compose-php73-tests.yml down --remove-orphans
include:
  - template: Jobs/Secret-Detection.gitlab-ci.yml

