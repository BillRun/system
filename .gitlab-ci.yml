image: serhii22ua/docker-compose-python10:latest-amd64

stages:
  - build
  - test

print-info:
 stage: build
 rules:
   - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS == "skip_ci"
 when: manual
 script:
   - 'echo "Job start: $CI_JOB_STARTED_AT"'
   - 'echo "Branch: $CI_COMMIT_BRANCH"'
   - 'echo "Commit Author: $CI_COMMIT_AUTHOR"'

.codecept:
  services:
   - name: docker:dind
     alias: dockerhost
  variables:
    DOCKER_HOST: tcp://dockerhost:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  stage: test
  tags:
    - new_docker_runner
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS != "skip_ci"
  before_script:
    # build and run BillRun app in docker
    - mkdir logs cache
    - chmod 777 logs/ cache/
    - cd $CI_PROJECT_DIR/docker/billrun-docker
    - docker-compose -f docker-compose-php73-tests.yml up --build --detach


  # Run php testcases
  script:
    - cd $CI_PROJECT_DIR/docker/billrun-docker/
    - docker exec -w /billrun -it billrun-app php vendor/bin/codecept run $TEST_NAME
    #- docker logs testing
    #- docker logs -f testing &> docker.log &
    - cd $CI_PROJECT_DIR/docker/billrun-docker
    - docker-compose -f docker-compose-php73-tests.yml down --remove-orphans

acceptance:
  extends: .codecept
  variables:
  TEST_NAME: "acceptance"

all:
  extends: .codecept
  variables:
  TEST_NAME: "all"

api:
  extends: .codecept
  variables:
  TEST_NAME: "api"
funcitonal:
  extends: .codecept
  variables:
  TEST_NAME: "functional"
unit:
  extends: .codecept
  variables:
  TEST_NAME: "unit"
