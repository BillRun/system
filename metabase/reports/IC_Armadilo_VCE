[

		{$match: {

      billrun : {{billing_cycle}}
}},

{$match:{"cf.product_group":{ $eq: "VCE" }}},

{$group: {"_id":{
  cash_flow:"$cf.cash_flow", 
  BILLED_PRODUCT: "$cf.product",
  BILLING_OPERATOR:"$cf.operator",
  BILLING_OPERATOR_N:"$cf.operator_title",
  MONTH:{$concat:[{$substr:["$uf.EVENT_START_DATE",0,4]},"-",{$substr:["$uf.EVENT_START_DATE",4,2]}]}, 
  EVENT_DIRECTION_G:"$cf.call_direction",
  RATING_SCENARIO:"$cf.scenario",
  RATING_SCENARIO_NAME:"$foreign.rate.description",
  USER_SUMMARISATION_G:"$uf.USER_SUMMARISATION",
  INCOMING_OPERATOR_D:"$cf.incoming_operator",
  OUTGOING_OPERATOR_D:"$cf.outgoing_operator",
  PRODUCT_GROUP:"$cf.product_group",
  TIER:"$cf.tier", 
  COMPONENT:"$cf.component"}, 
  "EVENT_DURATION_D": {$sum: "$usagev"}, 
  "CHARGE_EVENT_DURATION_D": {$sum: "$cf.cusagev"}, 
  CALL_COUNT_D:{$sum:"$lcount"}, 
  "aprice":{$sum: "$aprice"}}},
  {$addFields: {COSTY: 0,COSTX :0}},

{$project:{
  _id : 0,
  MONTH:"$_id.MONTH",
  BILLED_PRODUCT:"$_id.BILLED_PRODUCT",
  BILLING_OPERATOR:{'$ifNull':['$_id.BILLING_OPERATOR', ""]},
  OPERATOR_NAME:{'$ifNull':['$_id.BILLING_OPERATOR_N', ""]},
  PRODUCT_GROUP:"$_id.PRODUCT_GROUP",
  RATING_SCENARIO:{'$ifNull':["$_id.RATING_SCENARIO", ""]},
  RATING_SCENARIO_NAME:{'$ifNull':['$_id.RATING_SCENARIO_NAME', ""]},
  EVENT_DIRECTION:{'$ifNull':['$_id.EVENT_DIRECTION_G', ""]},
  TIER:"$_id.TIER",
  RATING_COMPONENT:"$_id.COMPONENT",
  USER_SUMMARISATION:"$_id.USER_SUMMARISATION_G",
  CASH_FLOW_COSTX:"REVENUE",
  COSTX:{$cond:[{ $eq: ["$_id.cash_flow","R"]},{$sum:"$aprice"},""]},
  COSTY:{$cond:[{ $eq: ["$_id.cash_flow","E"]},{$sum:"$aprice"},""]},
  CASH_FLOW_COSTY:"EXPENSE",
  CALL_COUNT:"$CALL_COUNT_D",
  EVENT_DURATION_D:{ $divide: ["$EVENT_DURATION_D", 60 ] },   
  CHARGE_EVENT_DURATION_D:{ $divide: ["$CHARGE_EVENT_DURATION_D", 60 ] },   
  INCOMING_OPERATOR:"$_id.INCOMING_OPERATOR_D",
  OUTGOING_OPERATOR:"$_id.OUTGOING_OPERATOR_D",
  TYPE_OF_USER:{$switch: {branches: [
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","MOB_POST_RES"] }, then: "Mobile Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","SUB_DIS"] }, then: "Mobile Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","MOB_UKN"] }, then: "Mobile Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","MTN_SHORT"] }, then: "Mobile Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","OUT_ROAMER"] }, then: "Mobile Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","VOICEMAIL"] }, then: "Mobile Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","THB"] }, then: "Mobile Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","XNULL"] }, then: "Mobile Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","1MB"] }, then: "Mobile Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","FIX_BUS"] }, then: "Fix Business" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","LSF"] }, then: "Fix Business" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","FIX_RES"] }, then: "Fix Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","MOB_POST_BUS"] }, then: "Mobile Business" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","EMERGENCY"] }, then: "Mobile Business" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","LCM"] }, then: "Mobile Business" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","LCR"] }, then: "Mobile Business" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","LRC"] }, then: "Mobile Business" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","LSM"] }, then: "Mobile Business" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","MOB_PREP_RES"] }, then: "Mobile Prepaid" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","CALLSAT_MVNO"] }, then: "MVNO" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","Transit"] }, then: "NONE" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","TRANSIT"] }, then: "NONE" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","IN_ROAM"] }, then: "NONE" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","IN_ROAM??"] }, then: "NONE" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","IN_ROAMER"] }, then: "NONE" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","TRANSIT1"] }, then: "NONE" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","A2PSMS"] }, then: "NONE" },
	{ case: {$eq: ["$_id.INCOMING_OPERATOR_D",null] }, then: "NONE" }
],default: "N/A"}},  
  CASH_FLOW: {$cond:[{ $eq: ["$_id.cash_flow","R"]},"Revenue","Expense"]},
}}
]