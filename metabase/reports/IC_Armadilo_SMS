[

		{$match: {
      billrun : {{billing_cycle}}
}},

{$match:{"cf.product" :"SMS"}},

{$group: {"_id":{
  cash_flow:"$cf.cash_flow", 
  BILLED_PRODUCT: "$cf.product",
  BILLING_OPERATOR:"$cf.operator",
  BILLING_OPERATOR_N:"$cf.operator_title",
  MONTH:{$concat:[{$substr:["$uf.EVENT_START_DATE",0,4]},"-",{$substr:["$uf.EVENT_START_DATE",4,2]}]},
  EVENT_DIRECTION_G:"$cf.call_direction",
  RATING_COMPONENT:"$cf.component",
  USER_SUMMARISATION_G:"$uf.USER_SUMMARISATION",
  INCOMING_OPERATOR_D:"$cf.incoming_operator",
  OUTGOING_OPERATOR_D:"$cf.outgoing_operator",
  PRODUCT_GROUP:"$cf.product_group",
  TIER:"$cf.tier", 
  COMPONENT:"$cf.component"},
  "duration": {$sum: "$usagev"}, 
  "charge_duration": {$sum: "$cf.cusagev"}, 
  CALL_COUNT_D:{$sum:"$lcount"}, 
  "aprice":{$sum: "$aprice"}}},

{$addFields: {COSTY: 0,COSTX :0}},

{$project:{
  _id : 0,
  MONTH:"$_id.MONTH",
  BILLED_PRODUCT:"$_id.BILLED_PRODUCT",
  BILLING_OPERATOR:{'$ifNull':['$_id.BILLING_OPERATOR', ""]},
  OPERATOR_NAME:{'$ifNull':['$_id.BILLING_OPERATOR_N', ""]},
  PRODUCT_GROUP:"$_id.PRODUCT_GROUP",
  EVENT_DIRECTION:"$_id.EVENT_DIRECTION_G",
  RATING_COMPONENT:{'$ifNull':["$_id.RATING_COMPONENT", ""]},
  TIER:"$_id.TIER",
  USER_SUMMARISATION:"$_id.USER_SUMMARISATION_G",
  CASH_FLOW_COSTX:"REVENUE",
  COSTX:{$cond:[{ $eq: ["$_id.cash_flow","R"]},{$sum:"$aprice"},""]},
  COSTY:{$cond:[{ $eq: ["$_id.cash_flow","E"]},{$sum:"$aprice"},""]},
  CASH_FLOW_COSTY:"EXPENSE",
  CALL_COUNT:"$CALL_COUNT_D",
  EVENT_DURATION:"$charge_duration",
  INCOMING_OPERATOR:"$_id.INCOMING_OPERATOR_D",
  OUTGOING_OPERATOR:"$_id.OUTGOING_OPERATOR_D",
  TYPE_INCOMING:{$switch: {branches: [
	{ case: {$eq: ["$_id.INCOMING_OPERATOR_D","CALSAT"] }, then: "NAT" },
	{ case: {$eq: ["$_id.INCOMING_OPERATOR_D","CYTA"] }, then: "NAT" },
	{ case: {$eq: ["$_id.INCOMING_OPERATOR_D","CABLE"] }, then: "NAT" },
	{ case: {$eq: ["$_id.INCOMING_OPERATOR_D","PTL"] }, then: "NAT" },
	{ case: {$eq: ["$_id.INCOMING_OPERATOR_D","BICS"] }, then: "HUB" },
	{ case: {$eq: ["$_id.INCOMING_OPERATOR_D","MONTY"] }, then: "HUB" },
	{ case: {$eq: ["$_id.INCOMING_OPERATOR_D","SYN"] }, then: "HUB" },
	{ case: {$eq: ["$_id.INCOMING_OPERATOR_D",null] }, then: "" }
],default: "IW"}},
TYPE_OUTGOING:{$switch: {branches: [
	{ case: {$eq: ["$_id.OUTGOING_OPERATOR_D","CALSAT"] }, then: "NAT" },
	{ case: {$eq: ["$_id.OUTGOING_OPERATOR_D","CYTA"] }, then: "NAT" },
	{ case: {$eq: ["$_id.OUTGOING_OPERATOR_D","CABLE"] }, then: "NAT" },
	{ case: {$eq: ["$_id.OUTGOING_OPERATOR_D","PTL"] }, then: "NAT" },
	{ case: {$eq: ["$_id.OUTGOING_OPERATOR_D","BICS"] }, then: "HUB" },
	{ case: {$eq: ["$_id.OUTGOING_OPERATOR_D","MONTY"] }, then: "HUB" },
	{ case: {$eq: ["$_id.OUTGOING_OPERATOR_D","SYN"] }, then: "HUB" },
	{ case: {$eq: ["$_id.OUTGOING_OPERATOR_D",null] }, then: "" }
],default: "IW"}},
USER_TYPE:{$switch: {branches: [
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","MOB_POST_RES"] }, then: "Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","FIX_RES"] }, then: "Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","MOB_UKN"] }, then: "Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","SUB_DIS"] }, then: "Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","THB"] }, then: "Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","XNULL"] }, then: "Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","LCM"] }, then: "Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","LCR"] }, then: "Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","LRC"] }, then: "Residential" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","MOB_PREP_RES"] }, then: "MVNO" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","MOB_POST_BUS"] }, then: "Business" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","FIX_BUS"] }, then: "Business" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","LSM"] }, then: "Business" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","LSF"] }, then: "Business" },
	{ case: {$eq: ["$_id.USER_SUMMARISATION_G","A2PSMS"] }, then: "Bulk" }
],default: ""}},
}}
]