[

		{$match: {
			   $and: [ {$and : [ { $expr: {$gte:['$urt', {
                        $dateFromParts: {
                            'year': {$year:{{from}}},
                            'month': {$month:{{from}}},
                            'day': { $dayOfMonth: {{from}} },
                            'hour': {$hour:{{from}}},
                            'minute': {$minute:{{from}}},
                            'second': {$second:{{from}}},
                            'millisecond': { $millisecond: {{from}} },
                            'timezone' : "Asia/Nicosia"
                        }
                    }]}}, {$expr:{$lt:['$urt', {
                        $dateFromParts: {
                            'year': {$year: {{to}}},
                            'month': {$month: {{to}}},
                            'day': { $dayOfMonth:  {{to}} },
                            'hour': {$hour: {{to}}},
                            'minute': {$minute: {{to}}},
                            'second': {$second: {{to}}},
                            'millisecond': { $millisecond:  {{to}} },
                            'timezone' : "Asia/Nicosia"
                        }
                    }
                ]}}]}]}},
{$match:{"cf.product" :"SMS"}},

{$group: {"_id":{
  cash_flow:"$cf.cash_flow", 
  BILLED_PRODUCT: "$cf.product",
  BILLING_OPERATOR:"$cf.operator",
  BILLING_OPERATOR_N:"$cf.operator_title",
  MONTH:{$concat:[{$substr:["$uf.EVENT_START_DATE",0,4]},"-",{$substr:["$uf.EVENT_START_DATE",4,2]}]},
  EVENT_DIRECTION_G:"$cf.call_direction",
  RATING_COMPONENT:"$cf.component",
  USER_SUMMARISATION_G:"$uf.USER_SUMMARISATION",
  INCOMING_OPERATOR_D:"$cf.incoming_operator",
  OUTGOING_OPERATOR_D:"$cf.outgoing_operator",
  PRODUCT_GROUP:"$cf.product_group",
  TIER:"$cf.tier", 
  COMPONENT:"$cf.component"},
  "duration": {$sum: "$usagev"}, 
  "charge_duration": {$sum: "$cf.cusagev"}, 
  CALL_COUNT_D:{$sum:1}, 
  "aprice":{$sum: "$aprice"}}},

{$addFields: {COSTY: 0,COSTX :0}},

{$project:{
  _id : 0,
  MONTH:"$_id.MONTH",
  BILLED_PRODUCT:"$_id.BILLED_PRODUCT",
  BILLING_OPERATOR:{'$ifNull':['$_id.BILLING_OPERATOR', ""]},
  BILLING_OPERATOR_N:{'$ifNull':['$_id.BILLING_OPERATOR_N', ""]},
  PRODUCT_GROUP:"$_id.PRODUCT_GROUP",
  EVENT_DIRECTION_G:"$_id.EVENT_DIRECTION_G",
  RATING_COMPONENT:{'$ifNull':["$_id.RATING_COMPONENT", ""]},
  TIER:"$_id.TIER",
  COMPONENT:"$_id.COMPONENT",
  USER_SUMMARISATION_G:"$_id.USER_SUMMARISATION_G",
  CASH_FLOW_COSTX:"REVENUE",
  COSTX:{$cond:[{ $eq: ["$_id.cash_flow","R"]},{$sum:"$aprice"},""]},
  COSTY:{$cond:[{ $eq: ["$_id.cash_flow","E"]},{$sum:"$aprice"},""]},
  CASH_FLOW_COSTY:"EXPENSE",
  CALL_COUNT_D:"$CALL_COUNT_D",
  EVENT_DURATION_D:"$duration",
  INCOMING_OPERATOR_D:"$_id.INCOMING_OPERATOR_D",
  OUTGOING_OPERATOR_D:"$_id.OUTGOING_OPERATOR_D",
  TYPE_INCOMING:"",
  TYPE_OUTGOING:"",
  USER_TYPE:"",
}}
]