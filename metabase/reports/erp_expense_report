[
		{
			$match: {
			   $and: [ {$and : [ { $expr: {$gte:['$urt', {
                        $dateFromParts: {
                            'year': {$year:{{from}}},
                            'month': {$month:{{from}}},
                            'day': { $dayOfMonth: {{from}} },
                            'hour': {$hour:{{from}}},
                            'minute': {$minute:{{from}}},
                            'second': {$second:{{from}}},
                            'millisecond': { $millisecond: {{from}} },
                            'timezone' : "Asia/Nicosia"
                        }
                    }]}}, {$expr:{$lt:['$urt', {
                        $dateFromParts: {
                            'year': {$year: {{to}}},
                            'month': {$month: {{to}}},
                            'day': { $dayOfMonth:  {{to}} },
                            'hour': {$hour: {{to}}},
                            'minute': {$minute: {{to}}},
                            'second': {$second: {{to}}},
                            'millisecond': { $millisecond:  {{to}} },
                            'timezone' : "Asia/Nicosia"
                        }
                    }
                ]}}]}]}},

{ $match : { "cf.cash_flow" : "EXPENSE" } },
{$group:{
_id:{scenario:"$cf.scenario",product:"$cf.product",component:"$cf.component",cash_flow: "$cf.cash_flow",USER_SUMMARISATION:"$uf.USER_SUMMARISATION",
operator:"$cf.operator",
aid: {$substr:["$aid", 0, -1 ]}},aprice:{$sum:"$aprice"}
}},

{$addFields: {
             MYKEY: { $concat: [
                     {$ifNull:["$_id.scenario",""]}, "_" ,
                     {$ifNull:["$_id.product",""]}, "_" ,
                     {$ifNull:["$_id.component",""]}, "_",
                     {$ifNull:["$_id.cash_flow",""]}, "_" ,
                     {$ifNull:["$_id.USER_SUMMARISATION",""]}, "_" ,
                     {$ifNull:["$_id.operator",""]},]}}},
{$lookup: {
             from: "epic_cy_erp_mapping",
             let: { key: "$MYKEY"},
             pipeline: [
                     {$match:{"$expr":{"$eq": ["$key", "$$key"]}}},
],
             as: "res"}},

{
         $addFields: {
            res: {$arrayElemAt: ["$res" , 0 ]}	    
         }
 }
 ,{$project:{
_id : 0, 
CSG_VOUCHER_DATE:{ $dateToString: { format: "%d/%m/%Y", date: { $subtract: [ {{to}}, { $multiply: [ { $dayOfMonth: {{to}} }, 24 , 60 , 60 , 1000]}]}, timezone: "Asia/Nicosia"} },
CSG_TRANSACTION_NO:"",
CUSTOMER_CODE:"",
CURRENCY:"EUR",

GL_ACCOUNT_NO:{$switch: {branches: [
{ case: {$eq: ["$_id.operator","AGI"] }, then: 90800668 },
{ case: {$eq: ["$_id.operator","ALNFA"] }, then: 90800665 },
{ case: {$eq: ["$_id.operator", "Alpha Media"] }, then: 90800676 },
{ case: {$eq: ["$_id.operator","BICS"] }, then: 90800672 },
{ case: {$eq: ["$_id.operator","CABLE"] }, then: 90800660 },
{ case: {$eq: ["$_id.operator","CALSAT"] }, then: 90800665 },
{ case: {$eq: ["$_id.operator","CYTA"] }, then: 90800671 },
{ case: {$eq: ["$_id.operator","DATA SMS"] }, then: 90800676 },
{ case: {$eq: ["$_id.operator","G.E.FOR ALL"] }, then: 90800676 },
{ case: {$eq: ["$_id.operator","GRAVITY SOLUTIONS"] }, then: 90800676 },
{ case: {$eq: ["$_id.operator","GT"] }, then: 90800676 },
{ case: {$eq: ["$_id.operator","HSMS"] }, then: 90800676 },
{ case: {$eq: ["$_id.operator","KPN"] }, then: 90800661 },
{ case: {$eq: ["$_id.operator","MONTY"] }, then: 90800673 },
{ case: {$eq: ["$_id.operator","MT"] }, then: 90800680 },
{ case: {$eq: ["$_id.operator","MTN SA"] }, then: 90300052 },
{ case: {$eq: ["$_id.operator","MTNSA"] }, then: 90300052 },
{ case: {$eq: ["$_id.operator","MTT"] }, then: 90800664 },
{ case: {$eq: ["$_id.operator","N.N REVERSE"] }, then: 90800676 },
{ case: {$eq: ["$_id.operator","NCC"] }, then: 90800677 },
{ case: {$eq: ["$_id.operator","NETSMART"] }, then: 90800676 },
{ case: {$eq: ["$_id.operator","OTE"] }, then: 90800670 },
{ case: {$eq: ["$_id.operator","Otero" ] }, then: 90800676 },
{ case: {$eq: ["$_id.operator","PCCW"] }, then: 90800679 },
{ case: {$eq: ["$_id.operator","PTL"] }, then: 90800669 },
{ case: {$eq: ["$_id.operator","SAP"] }, then: 90800659 },
{ case: {$eq: ["$_id.operator","SPINT"] }, then: 90800681 },
{ case: { $eq:["$_id.operator","SYN"] }, then: 90800666 },
{ case: {$eq: ["$_id.operator","Syn-Aicent"] }, then: 90800674 },
{ case: {$eq: ["$_id.operator","TATA"] }, then: 90800678 },
{ case: {$eq: ["$_id.operator","TELIA"] }, then: 90800667 },
{ case: {$eq: ["$_id.operator","TIS"] }, then: 90800662 },
{ case: {$eq: ["$_id.operator","TPOINT"] }, then: 90800663 },
{ case: {$eq: ["$_id.operator","YEMAN"] }, then: 90800676 },
],default: 90800675}},

STORE:"",
TRANS_DATE:{ $dateToString: { format: "%d/%m/%Y", date: new Date(), timezone: "Asia/Nicosia"} },
REFERENCE_NO :{ $concat: [{ $dateToString: { format: "%m%Y", date: {{from}}, timezone: "Asia/Nicosia"} },"$_id.aid",{ $dateToString: { format: "%m%Y", date: {{to}}, timezone: "Asia/Nicosia"} }]},
ITEM_PRODUCT_GROUP:"",
MTN_IND:'$res.mtn_ind',
MISC_SUB_L : "PRO",
PROD_SERV:'$res.prod_serv',
DEBIT_AMOUNT: "$aprice",
CREDIT_AMOUNT:"0"
}}
,{$group:{"_id":"$REFERENCE_NO", exps: { $push: "$$ROOT" }}}

,{$addFields:{CREDIT_AMOUNT : { $sum: "$exps.DEBIT_AMOUNT" },
		res_exps: {$arrayElemAt: ["$exps" , 0 ]}}}
		
		,{$project:{_id : 0,items:{$concatArrays : ["$exps", 
		[{ "CSG_VOUCHER_DATE" : "$res_exps.CSG_VOUCHER_DATE",
		"CSG_TRANSACTION_NO" : "$res_exps.CSG_TRANSACTION_NO","CUSTOMER_CODE" : "$res_exps.CUSTOMER_CODE","CURRENCY" : "$res_exps.CURRENCY","GL_ACCOUNT_NO" : "","STORE" : "$res_exps.STORE",
		"TRANS_DATE" : "$res_exps.TRANS_DATE",
		    "REFERENCE_NO" : "$res_exps.REFERENCE_NO",
		    "ITEM_PRODUCT_GROUP" : "$res_exps.ITEM_PRODUCT_GROUP",
		    "MTN_IND" : "","MISC_SUB_L" : "PRO","PROD_SERV" : "$res_exps.PROD_SERV","DEBIT_AMOUNT" : "0.00","CREDIT_AMOUNT": "$CREDIT_AMOUNT"
		}] ] }}}
		
		,{ $unwind : "$items" }
		
	,{$project:{_id : 0,CSG_VOUCHER_DATE : "$items.CSG_VOUCHER_DATE",CSG_TRANSACTION_NO:"$items.CSG_TRANSACTION_NO",CUSTOMER_CODE : "$items.CUSTOMER_CODE", CURRENCY : "$items.CURRENCY", GL_ACCOUNT_NO : "$items.GL_ACCOUNT_NO", STORE : "$items.STORE", TRANS_DATE : "$items.TRANS_DATE", REFERENCE_NO : "$items.REFERENCE_NO", ITEM_PRODUCT_GROUP : "$items.ITEM_PRODUCT_GROUP", MTN_IND : "$items.MTN_IND", MISC_SUB_L : "$items.MISC_SUB_L", PROD_SERV : "$items.PROD_SERV", DEBIT_AMOUNT : "$items.DEBIT_AMOUNT",CREDIT_AMOUNT: "$items.CREDIT_AMOUNT"}}
]