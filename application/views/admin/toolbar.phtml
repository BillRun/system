<div class="toolbar toolbar-<?php echo $active; ?>">
	<form id="search-criteria" action="<?php echo $baseUrl . $requestUrl; ?>" method="POST" class="form-vertical">
		<input type="hidden" id="queryType" name="queryType" value="find" />
		<?php
//		print_R($this->filter_fields_order);
//		print_R($this->filter_fields);die;
		if (is_array($this->filter_fields_order) && is_array($this->filter_fields)) {
			foreach ($this->filter_fields_order as $key => $row_fields) {
				echo "<div class=\"control-group control-group" . $key . "\">
							<div class=\"controls form-inline\">";
				foreach ($row_fields as $filter_field_key => $field_view) {
					$filter_field = $this->filter_fields[$filter_field_key];
					if ($filter_field['input_type'] == 'boolean') {
						echo "<input class=\"form-control span" . $field_view['width'] . "\" id=\"" . $filter_field['key'] . "\" name=\"" . $filter_field['key'] . "\" type=\"checkbox\"" . (isset($this->session->{$filter_field['key']}) && $this->session->{$filter_field['key']} == "on" ? " value=\"on\" checked=\"checked\"" : "") . ">"
						. "<label class=\"checkbox\" for=\"" . $filter_field['key'] . "\">" . $filter_field['display'] . "</label>";
					} else if ($filter_field['input_type'] == 'number') {
						echo "&nbsp;<label class=\"control-label\" for=\"" . $filter_field['key'] . "\">" . $filter_field['display'] . "</label>
								<input id=\"" . $filter_field['key'] . "\" class=\"form-control span" . $field_view['width'] . "\" name=\"" . $filter_field['key'] . "\" type=\"text\" value=\"" . (isset($this->session->{$filter_field['key']}) ? $this->session->{$filter_field['key']} : $filter_field['default']) . "\">";
					} else if ($filter_field['input_type'] == 'text') {
						echo "&nbsp;<label class=\"control-label\" for=\"" . $filter_field['key'] . "\">" . $filter_field['display'] . "</label>
								<input id=\"" . $filter_field['key'] . "\" class=\"form-control span" . $field_view['width'] . "\" name=\"" . $filter_field['key']
						. "\" type=\"text\" value=\""
						. (isset($this->session->{$filter_field['key']}) ? $this->session->{$filter_field['key']} : $filter_field['default'])
						. "\">";
					} else if ($filter_field['input_type'] == 'date') {
						echo "&nbsp;<label class=\"control-label\">" . $filter_field['display'] . "</label>
								<div class=\"input-group date\" id=\"datetimepicker_" . $filter_field['key'] . "\" data-date=\"" . $filter_field['default'] . "\" data-date-format=\"YYYY-MM-DD HH:mm:ss\">
								<input name=\"" . $filter_field['key'] . "\" class=\"form-control\" size=\"16\" type=\"text\" value=\"" . (isset($this->session->{$filter_field['key']}) ? $this->session->{$filter_field['key']} : $filter_field['default']) . "\">
								<span class=\"input-group-addon\"><span class=\"glyphicon glyphicon-calendar\"></span></span>
								</div>";
					} else if ($filter_field['input_type'] == 'multiselect') {
						echo "&nbsp;<label class=\"control-label\">" . $filter_field['display'] . "</label>
						<select id=\"" . $filter_field['key'] . "\" name=\"" . $filter_field['key'] . "[]\" class=\"form-control multiselect\"" . (isset($filter_field['singleselect'])?"" : " multiple=\"multiple\"") . ">";
						foreach ($filter_field['values'] as $value => $name) {
							if (is_array($this->session->{$filter_field['key']})) {
								if (in_array($value, $this->session->{$filter_field['key']})) {
									$selected = " selected";
								} else {
									$selected = "";
								}
							} else if (is_array($filter_field['default']) && in_array($value, $filter_field['default'])) {
								$selected = " selected";
							} else {
								$selected = "";
							}
							echo "<option value=\"" . $value . "\"" . $selected . ">" . $name . "</option>";
						}
						echo "</select>";
					}
				}
				echo "</div></div>";
			}

			if ($active == 'lines') :
				$groupBySelect = $this->session->groupBySelect;
				$isGroupBy = is_array($groupBySelect);
				$isGroupFilter = $isGroupBy && Admin_Lines::isGroupFilter($this->session);
				$isManualFilter = Admin_Lines::isManualFilter($this->session);
				echo "<div id=\"AdvancedAndAggregated\">";
					echo "<div id=\"AdvancedParentDiv\">";
						echo "<div>"
								. "<a href=\"javascript:void(0)\" class=\"advanced-options\">"
									. "<i class=\"glyphicon glyphicon-" . ($isManualFilter ? "minus" : "plus") . "-sign\"></i>"
								. " Advanced options "	
						   		. "</a>"
							. "</div>";
						echo "<div id = \"manual_filters\"" . ($isManualFilter ? "" : " style=\"display:none;\"") . ">";
							echo '<div class="filters">';
								if ($isManualFilter) {
									for ($i = 0; $i < count($this->session->manual_key); $i++) {
										echo Admin_Lines::getFilterRow($this->session->manual_key[$i], isset($this->session->manual_type[$i]) ? $this->session->manual_type[$i] : NULL, $this->session->manual_operator[$i], $this->session->manual_value[$i]);
									}
								} else {
									echo Admin_Lines::getFilterRow(); // add first manual filter on load
								}

							echo '</div>';
							echo '<br>';
							echo "<div id='databases' class='hide' >Select table to fetch from: ";
								echo "<select class='form-control multiselect'  name='collection'>";
									$coll_selection = $this->session->collectionSelect;
									if ($coll_selection == 'lines|billing'){
										$bill_mark = 'selected';
									} else {
										$bill_mark = '';
									}

									$split_coll = explode('|', $coll_selection);
									$coll = $split_coll[0];
									$db = $split_coll[1];

									echo	"<option value='" . 'lines' . "|" . 'billing' . "' $bill_mark>lines (billing)</option>";
									$archiveCollections = LinesModel::getArchiveLinesCollections();
									foreach($archiveCollections as $collection){
										if (($db == 'archive') && ($collection == $coll)){
											$archive_mark = 'selected';
										} else {
											$archive_mark = '';
										}
										echo	"<option value='" . $collection . "|" . 'archive' . "' $archive_mark>$collection (archive)</option>";
									}		
									$historyArchiveCollections = LinesModel::getHistoryArchiveLinesCollections();
									foreach($historyArchiveCollections as $collection){
										if (($db == 'historyarchive') && ($collection == $coll)){
											$archive_mark = 'selected';
										} else {
											$archive_mark = '';
										}
										echo	"<option value='" . $collection . "|" . 'historyarchive' . "' $archive_mark>$collection (archive)</option>";
									}		
								echo "</select>";
							echo "</div>";
							
							echo '</br>';	
						echo '</div>';
					echo '</div>';
				
					echo "<div id=\"AggregateParentDiv\">";
						echo "<div id='groupData'>";
							echo "<a href='javascript:void(0)' class='groupData'>" .
									"<i class=\"glyphicon glyphicon-" . ($isGroupFilter ? "minus" : "plus") . "-sign\"></i>" .
								" Group options" .
								 "</a>" .
							"</div>";
						echo "<div id = 'groupBy' " . ($isGroupFilter ? "" : " style=\"display:none;\"") . ">";
							echo "&nbsp;<label class='control-label'>Group by</label>
							<select id='groupBySelect[]' name='groupBySelect[]' class='form-control multiselect' multiple='multiple'>";
								foreach ($aggregate_by_fields as $value => $name) {
									$selected = "";
									if ($isGroupBy	 &&
										(in_array($value, $groupBySelect))){
											$selected = " selected";
									}

									echo "<option value='$value' $selected>$name</option>";
								}
							echo "</select>";
						echo '</div>';
						echo "<div id = 'group_by_filters' " . ($isGroupFilter ? "" : " style=\"display:none;\"") . ">";
								if ($isGroupFilter) {
									for ($i = 0; $i < count($this->session->group_data_keys); $i++) {
										echo Admin_Lines::getGroupRow($this->session->group_data_keys[$i], null, $this->session->group_data_operators[$i], $this->session->group_value[$i]);
									}
								} else {
									echo Admin_Lines::getGroupRow(); // add first manual filter on load
								}
						echo '</div>';
					echo "</div>";
				echo "</div>";
			echo "<br><br><input id='long_query' name='long_query' type='checkbox'>Allow long query</input><br><br>";
			elseif ($active == 'rates') :
			endif;
			if ($active == 'lines' || $active == 'rates' || $active == 'balances' || $active == 'events'):
				echo "<div class=\"control-group control-group4\"><div id=\"extra_columns\" class=\"controls form-inline\">"
				. "&nbsp;<label class=\"control-label\">Display fields</label>
						<select name=\"extra_columns[]\" class=\"form-control multiselect\" multiple=\"multiple\">";
				foreach ($this->extra_columns as $value => $name) {
					$selected = "";
					if (is_array($this->session->extra_columns) && in_array($value, $this->session->extra_columns)) {
						$selected = " selected";
					}
					echo "<option value=\"" . $value . "\"" . $selected . ">" . $name . "</option>";
				}
				echo "</select>";
				echo "</div></div>";
			endif;
			if (is_array($this->sort_fields) && $this->sort_fields) {
				echo "Sort by: <div class=\"control-group control-group5\">
		<div class=\"controls form-inline\">
			 <select id=\"sort_by\" name=\"sort_by\" class=\"form-control multiselect\">";
				foreach ($this->sort_fields as $sort_field_key => $sort_field_display) {
//					if($isGroupBy && !isset($aggregate_by_fields[$sort_field_key])) {
//						continue;
//					}
					echo "<option value=\"" . $sort_field_key . "\"" . (isset($this->session->sort_by) && $this->session->sort_by == $sort_field_key ? " selected=\"selected\"" : "") . ">" . $sort_field_display . "</option>";
				}
				echo "</select>
			<label class=\"radio inline\">
                                <input name=\"order\" value=\"desc\" type=\"radio\"" . ((isset($this->session->order) && $this->session->order == "desc") ? " checked=\"checked\"" : "") . "> Descending order
			</label>
			<label class=\"radio inline\">
                                <input name=\"order\" value=\"asc\" type=\"radio\"" . ((isset($this->session->order) && $this->session->order == "desc") ? "" : " checked=\"checked\"") . "> Ascending order
			</label>
		</div></div>";
			}
		}
		$this->display('toolbarbuttons.phtml', array());
		?>
	</form>
</div>
